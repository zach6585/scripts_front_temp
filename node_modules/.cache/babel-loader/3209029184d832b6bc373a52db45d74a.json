{"ast":null,"code":"import { sleep, randomToken } from './util.js';\nimport unload from 'unload';\n\nvar LeaderElection = function LeaderElection(channel, options) {\n  this._channel = channel;\n  this._options = options;\n  this.isLeader = false;\n  this.isDead = false;\n  this.token = randomToken();\n  this._isApl = false; // _isApplying\n\n  this._reApply = false; // things to clean up\n\n  this._unl = []; // _unloads\n\n  this._lstns = []; // _listeners\n\n  this._invs = []; // _intervals\n\n  this._dpL = function () {}; // onduplicate listener\n\n\n  this._dpLC = false; // true when onduplicate called\n};\n\nLeaderElection.prototype = {\n  applyOnce: function applyOnce() {\n    var _this = this;\n\n    if (this.isLeader) return Promise.resolve(false);\n    if (this.isDead) return Promise.resolve(false); // do nothing if already running\n\n    if (this._isApl) {\n      this._reApply = true;\n      return Promise.resolve(false);\n    }\n\n    this._isApl = true;\n    var stopCriteria = false;\n    var recieved = [];\n\n    var handleMessage = function handleMessage(msg) {\n      if (msg.context === 'leader' && msg.token != _this.token) {\n        recieved.push(msg);\n\n        if (msg.action === 'apply') {\n          // other is applying\n          if (msg.token > _this.token) {\n            // other has higher token, stop applying\n            stopCriteria = true;\n          }\n        }\n\n        if (msg.action === 'tell') {\n          // other is already leader\n          stopCriteria = true;\n        }\n      }\n    };\n\n    this._channel.addEventListener('internal', handleMessage);\n\n    var ret = _sendMessage(this, 'apply') // send out that this one is applying\n    .then(function () {\n      return sleep(_this._options.responseTime);\n    }) // let others time to respond\n    .then(function () {\n      if (stopCriteria) return Promise.reject(new Error());else return _sendMessage(_this, 'apply');\n    }).then(function () {\n      return sleep(_this._options.responseTime);\n    }) // let others time to respond\n    .then(function () {\n      if (stopCriteria) return Promise.reject(new Error());else return _sendMessage(_this);\n    }).then(function () {\n      return beLeader(_this);\n    }) // no one disagreed -> this one is now leader\n    .then(function () {\n      return true;\n    })[\"catch\"](function () {\n      return false;\n    }) // apply not successfull\n    .then(function (success) {\n      _this._channel.removeEventListener('internal', handleMessage);\n\n      _this._isApl = false;\n\n      if (!success && _this._reApply) {\n        _this._reApply = false;\n        return _this.applyOnce();\n      } else return success;\n    });\n\n    return ret;\n  },\n  awaitLeadership: function awaitLeadership() {\n    if (\n    /* _awaitLeadershipPromise */\n    !this._aLP) {\n      this._aLP = _awaitLeadershipOnce(this);\n    }\n\n    return this._aLP;\n  },\n\n  set onduplicate(fn) {\n    this._dpL = fn;\n  },\n\n  die: function die() {\n    var _this2 = this;\n\n    if (this.isDead) return;\n    this.isDead = true;\n\n    this._lstns.forEach(function (listener) {\n      return _this2._channel.removeEventListener('internal', listener);\n    });\n\n    this._invs.forEach(function (interval) {\n      return clearInterval(interval);\n    });\n\n    this._unl.forEach(function (uFn) {\n      uFn.remove();\n    });\n\n    return _sendMessage(this, 'death');\n  }\n};\n\nfunction _awaitLeadershipOnce(leaderElector) {\n  if (leaderElector.isLeader) return Promise.resolve();\n  return new Promise(function (res) {\n    var resolved = false;\n\n    function finish() {\n      if (resolved) {\n        return;\n      }\n\n      resolved = true;\n      clearInterval(interval);\n\n      leaderElector._channel.removeEventListener('internal', whenDeathListener);\n\n      res(true);\n    } // try once now\n\n\n    leaderElector.applyOnce().then(function () {\n      if (leaderElector.isLeader) {\n        finish();\n      }\n    }); // try on fallbackInterval\n\n    var interval = setInterval(function () {\n      leaderElector.applyOnce().then(function () {\n        if (leaderElector.isLeader) {\n          finish();\n        }\n      });\n    }, leaderElector._options.fallbackInterval);\n\n    leaderElector._invs.push(interval); // try when other leader dies\n\n\n    var whenDeathListener = function whenDeathListener(msg) {\n      if (msg.context === 'leader' && msg.action === 'death') {\n        leaderElector.applyOnce().then(function () {\n          if (leaderElector.isLeader) finish();\n        });\n      }\n    };\n\n    leaderElector._channel.addEventListener('internal', whenDeathListener);\n\n    leaderElector._lstns.push(whenDeathListener);\n  });\n}\n/**\n * sends and internal message over the broadcast-channel\n */\n\n\nfunction _sendMessage(leaderElector, action) {\n  var msgJson = {\n    context: 'leader',\n    action: action,\n    token: leaderElector.token\n  };\n  return leaderElector._channel.postInternal(msgJson);\n}\n\nexport function beLeader(leaderElector) {\n  leaderElector.isLeader = true;\n  var unloadFn = unload.add(function () {\n    return leaderElector.die();\n  });\n\n  leaderElector._unl.push(unloadFn);\n\n  var isLeaderListener = function isLeaderListener(msg) {\n    if (msg.context === 'leader' && msg.action === 'apply') {\n      _sendMessage(leaderElector, 'tell');\n    }\n\n    if (msg.context === 'leader' && msg.action === 'tell' && !leaderElector._dpLC) {\n      /**\n       * another instance is also leader!\n       * This can happen on rare events\n       * like when the CPU is at 100% for long time\n       * or the tabs are open very long and the browser throttles them.\n       * @link https://github.com/pubkey/broadcast-channel/issues/414\n       * @link https://github.com/pubkey/broadcast-channel/issues/385\n       */\n      leaderElector._dpLC = true;\n\n      leaderElector._dpL(); // message the lib user so the app can handle the problem\n\n\n      _sendMessage(leaderElector, 'tell'); // ensure other leader also knows the problem\n\n    }\n  };\n\n  leaderElector._channel.addEventListener('internal', isLeaderListener);\n\n  leaderElector._lstns.push(isLeaderListener);\n\n  return _sendMessage(leaderElector, 'tell');\n}\n\nfunction fillOptionsWithDefaults(options, channel) {\n  if (!options) options = {};\n  options = JSON.parse(JSON.stringify(options));\n\n  if (!options.fallbackInterval) {\n    options.fallbackInterval = 3000;\n  }\n\n  if (!options.responseTime) {\n    options.responseTime = channel.method.averageResponseTime(channel.options);\n  }\n\n  return options;\n}\n\nexport function createLeaderElection(channel, options) {\n  if (channel._leaderElector) {\n    throw new Error('BroadcastChannel already has a leader-elector');\n  }\n\n  options = fillOptionsWithDefaults(options, channel);\n  var elector = new LeaderElection(channel, options);\n\n  channel._befC.push(function () {\n    return elector.die();\n  });\n\n  channel._leaderElector = elector;\n  return elector;\n}","map":{"version":3,"sources":["/mnt/c/Users/moust/Documents/Scripts/frontend/node_modules/broadcast-channel/dist/es/leader-election.js"],"names":["sleep","randomToken","unload","LeaderElection","channel","options","_channel","_options","isLeader","isDead","token","_isApl","_reApply","_unl","_lstns","_invs","_dpL","_dpLC","prototype","applyOnce","_this","Promise","resolve","stopCriteria","recieved","handleMessage","msg","context","push","action","addEventListener","ret","_sendMessage","then","responseTime","reject","Error","beLeader","success","removeEventListener","awaitLeadership","_aLP","_awaitLeadershipOnce","onduplicate","fn","die","_this2","forEach","listener","interval","clearInterval","uFn","remove","leaderElector","res","resolved","finish","whenDeathListener","setInterval","fallbackInterval","msgJson","postInternal","unloadFn","add","isLeaderListener","fillOptionsWithDefaults","JSON","parse","stringify","method","averageResponseTime","createLeaderElection","_leaderElector","elector","_befC"],"mappings":"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","sourcesContent":["import { sleep, randomToken } from './util.js';\nimport unload from 'unload';\n\nvar LeaderElection = function LeaderElection(channel, options) {\n  this._channel = channel;\n  this._options = options;\n  this.isLeader = false;\n  this.isDead = false;\n  this.token = randomToken();\n  this._isApl = false; // _isApplying\n\n  this._reApply = false; // things to clean up\n\n  this._unl = []; // _unloads\n\n  this._lstns = []; // _listeners\n\n  this._invs = []; // _intervals\n\n  this._dpL = function () {}; // onduplicate listener\n\n\n  this._dpLC = false; // true when onduplicate called\n};\n\nLeaderElection.prototype = {\n  applyOnce: function applyOnce() {\n    var _this = this;\n\n    if (this.isLeader) return Promise.resolve(false);\n    if (this.isDead) return Promise.resolve(false); // do nothing if already running\n\n    if (this._isApl) {\n      this._reApply = true;\n      return Promise.resolve(false);\n    }\n\n    this._isApl = true;\n    var stopCriteria = false;\n    var recieved = [];\n\n    var handleMessage = function handleMessage(msg) {\n      if (msg.context === 'leader' && msg.token != _this.token) {\n        recieved.push(msg);\n\n        if (msg.action === 'apply') {\n          // other is applying\n          if (msg.token > _this.token) {\n            // other has higher token, stop applying\n            stopCriteria = true;\n          }\n        }\n\n        if (msg.action === 'tell') {\n          // other is already leader\n          stopCriteria = true;\n        }\n      }\n    };\n\n    this._channel.addEventListener('internal', handleMessage);\n\n    var ret = _sendMessage(this, 'apply') // send out that this one is applying\n    .then(function () {\n      return sleep(_this._options.responseTime);\n    }) // let others time to respond\n    .then(function () {\n      if (stopCriteria) return Promise.reject(new Error());else return _sendMessage(_this, 'apply');\n    }).then(function () {\n      return sleep(_this._options.responseTime);\n    }) // let others time to respond\n    .then(function () {\n      if (stopCriteria) return Promise.reject(new Error());else return _sendMessage(_this);\n    }).then(function () {\n      return beLeader(_this);\n    }) // no one disagreed -> this one is now leader\n    .then(function () {\n      return true;\n    })[\"catch\"](function () {\n      return false;\n    }) // apply not successfull\n    .then(function (success) {\n      _this._channel.removeEventListener('internal', handleMessage);\n\n      _this._isApl = false;\n\n      if (!success && _this._reApply) {\n        _this._reApply = false;\n        return _this.applyOnce();\n      } else return success;\n    });\n\n    return ret;\n  },\n  awaitLeadership: function awaitLeadership() {\n    if (\n    /* _awaitLeadershipPromise */\n    !this._aLP) {\n      this._aLP = _awaitLeadershipOnce(this);\n    }\n\n    return this._aLP;\n  },\n\n  set onduplicate(fn) {\n    this._dpL = fn;\n  },\n\n  die: function die() {\n    var _this2 = this;\n\n    if (this.isDead) return;\n    this.isDead = true;\n\n    this._lstns.forEach(function (listener) {\n      return _this2._channel.removeEventListener('internal', listener);\n    });\n\n    this._invs.forEach(function (interval) {\n      return clearInterval(interval);\n    });\n\n    this._unl.forEach(function (uFn) {\n      uFn.remove();\n    });\n\n    return _sendMessage(this, 'death');\n  }\n};\n\nfunction _awaitLeadershipOnce(leaderElector) {\n  if (leaderElector.isLeader) return Promise.resolve();\n  return new Promise(function (res) {\n    var resolved = false;\n\n    function finish() {\n      if (resolved) {\n        return;\n      }\n\n      resolved = true;\n      clearInterval(interval);\n\n      leaderElector._channel.removeEventListener('internal', whenDeathListener);\n\n      res(true);\n    } // try once now\n\n\n    leaderElector.applyOnce().then(function () {\n      if (leaderElector.isLeader) {\n        finish();\n      }\n    }); // try on fallbackInterval\n\n    var interval = setInterval(function () {\n      leaderElector.applyOnce().then(function () {\n        if (leaderElector.isLeader) {\n          finish();\n        }\n      });\n    }, leaderElector._options.fallbackInterval);\n\n    leaderElector._invs.push(interval); // try when other leader dies\n\n\n    var whenDeathListener = function whenDeathListener(msg) {\n      if (msg.context === 'leader' && msg.action === 'death') {\n        leaderElector.applyOnce().then(function () {\n          if (leaderElector.isLeader) finish();\n        });\n      }\n    };\n\n    leaderElector._channel.addEventListener('internal', whenDeathListener);\n\n    leaderElector._lstns.push(whenDeathListener);\n  });\n}\n/**\n * sends and internal message over the broadcast-channel\n */\n\n\nfunction _sendMessage(leaderElector, action) {\n  var msgJson = {\n    context: 'leader',\n    action: action,\n    token: leaderElector.token\n  };\n  return leaderElector._channel.postInternal(msgJson);\n}\n\nexport function beLeader(leaderElector) {\n  leaderElector.isLeader = true;\n  var unloadFn = unload.add(function () {\n    return leaderElector.die();\n  });\n\n  leaderElector._unl.push(unloadFn);\n\n  var isLeaderListener = function isLeaderListener(msg) {\n    if (msg.context === 'leader' && msg.action === 'apply') {\n      _sendMessage(leaderElector, 'tell');\n    }\n\n    if (msg.context === 'leader' && msg.action === 'tell' && !leaderElector._dpLC) {\n      /**\n       * another instance is also leader!\n       * This can happen on rare events\n       * like when the CPU is at 100% for long time\n       * or the tabs are open very long and the browser throttles them.\n       * @link https://github.com/pubkey/broadcast-channel/issues/414\n       * @link https://github.com/pubkey/broadcast-channel/issues/385\n       */\n      leaderElector._dpLC = true;\n\n      leaderElector._dpL(); // message the lib user so the app can handle the problem\n\n\n      _sendMessage(leaderElector, 'tell'); // ensure other leader also knows the problem\n\n    }\n  };\n\n  leaderElector._channel.addEventListener('internal', isLeaderListener);\n\n  leaderElector._lstns.push(isLeaderListener);\n\n  return _sendMessage(leaderElector, 'tell');\n}\n\nfunction fillOptionsWithDefaults(options, channel) {\n  if (!options) options = {};\n  options = JSON.parse(JSON.stringify(options));\n\n  if (!options.fallbackInterval) {\n    options.fallbackInterval = 3000;\n  }\n\n  if (!options.responseTime) {\n    options.responseTime = channel.method.averageResponseTime(channel.options);\n  }\n\n  return options;\n}\n\nexport function createLeaderElection(channel, options) {\n  if (channel._leaderElector) {\n    throw new Error('BroadcastChannel already has a leader-elector');\n  }\n\n  options = fillOptionsWithDefaults(options, channel);\n  var elector = new LeaderElection(channel, options);\n\n  channel._befC.push(function () {\n    return elector.die();\n  });\n\n  channel._leaderElector = elector;\n  return elector;\n}"]},"metadata":{},"sourceType":"module"}